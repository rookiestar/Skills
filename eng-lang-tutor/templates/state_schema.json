{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "state_schema.json",
  "title": "State",
  "description": "Core state for eng-lang-tutor skill",
  "type": "object",
  "required": ["version", "initialized", "user", "preferences", "progress", "recent_topics", "error_notebook", "completion_status"],
  "properties": {
    "version": {
      "type": "integer",
      "const": 2,
      "description": "Schema version"
    },
    "initialized": {
      "type": "boolean",
      "default": false,
      "description": "Whether user has completed onboarding"
    },
    "onboarding_step": {
      "type": "integer",
      "minimum": 0,
      "maximum": 7,
      "default": 0,
      "description": "Current onboarding step (0=not started, 7=complete)"
    },
    "completion_status": {
      "type": "object",
      "properties": {
        "quiz_completed_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "Date when quiz was last completed"
        },
        "keypoint_view_history": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "date": { "type": "string", "format": "date" },
              "viewed_at": { "type": "string", "format": "date-time" }
            }
          },
          "description": "History of viewed keypoints"
        }
      },
      "description": "Tracks completion status for quizzes and exercises"
    },
    "schedule": {
      "type": "object",
      "properties": {
        "keypoint_time": {
          "type": "string",
          "pattern": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$",
          "default": "06:45",
          "description": "Daily keypoint push time (HH:MM)"
        },
        "quiz_time": {
          "type": "string",
          "pattern": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$",
          "default": "22:45",
          "description": "Daily quiz push time (HH:MM)"
        },
        "timezone": {
          "type": "string",
          "default": "Asia/Shanghai",
          "description": "Timezone for schedule"
        }
      },
      "description": "User's preferred schedule for content delivery"
    },
    "user": {
      "type": "object",
      "required": ["xp", "level", "streak", "streak_freeze", "gems", "badges"],
      "properties": {
        "xp": {
          "type": "integer",
          "minimum": 0,
          "description": "Total experience points"
        },
        "level": {
          "type": "integer",
          "minimum": 1,
          "maximum": 20,
          "description": "Activity Level (活跃等级): measures engagement depth, NOT language ability. Stages: Starter(1-5), Traveler(6-10), Explorer(11-15), Pioneer(16-20)"
        },
        "streak": {
          "type": "integer",
          "minimum": 0,
          "description": "Consecutive study days"
        },
        "streak_freeze": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of streak freeze items available"
        },
        "gems": {
          "type": "integer",
          "minimum": 0,
          "description": "Currency for streak freeze and hints"
        },
        "badges": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["first_steps", "week_warrior", "month_master", "perfect_10", "vocab_hunter", "error_slayer"]
          },
          "description": "Earned badges"
        }
      }
    },
    "preferences": {
      "type": "object",
      "required": ["cefr_level", "oral_written_ratio", "topics", "tutor_style", "dedup_days"],
      "properties": {
        "cefr_level": {
          "type": "string",
          "enum": ["A1", "A2", "B1", "B2", "C1", "C2"],
          "default": "B1",
          "description": "Ability Level (能力等级): CEFR standard for content difficulty matching"
        },
        "oral_written_ratio": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "default": 0.7,
          "description": "Ratio of oral to written expressions (0.7 = 70% oral)"
        },
        "topics": {
          "type": "object",
          "properties": {
            "movies": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.2 },
            "news": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.15 },
            "gaming": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.15 },
            "sports": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.1 },
            "workplace": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.2 },
            "social": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.1 },
            "daily_life": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.1 }
          },
          "description": "Topic preference weights (should sum to 1.0)"
        },
        "tutor_style": {
          "type": "string",
          "enum": ["humorous", "rigorous", "casual", "professional"],
          "default": "humorous",
          "description": "Tutor personality style"
        },
        "dedup_days": {
          "type": "integer",
          "minimum": 7,
          "maximum": 30,
          "default": 14,
          "description": "Days to look back for content deduplication"
        }
      }
    },
    "tts_settings": {
      "type": "object",
      "description": "TTS voice and speed configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Whether voice teaching is enabled"
        },
        "provider": {
          "type": "string",
          "enum": ["edge-tts", "xunfei"],
          "default": "edge-tts",
          "description": "TTS provider to use"
        },
        "speed": {
          "type": "number",
          "enum": [0.5, 0.7, 0.9, 1.3, 1.7],
          "default": 0.9,
          "description": "Speech speed: 0.5=very slow, 0.7=slow, 0.9=normal(recommended), 1.3=fast, 1.7=very fast"
        },
        "voices": {
          "type": "object",
          "description": "Voice mappings for different roles",
          "properties": {
            "narrator": {
              "type": "string",
              "description": "Narrator voice (female by default)"
            },
            "dialogue_a": {
              "type": "string",
              "description": "Dialogue A voice (male by default)"
            },
            "dialogue_b": {
              "type": "string",
              "description": "Dialogue B voice (female by default)"
            }
          }
        }
      }
    },
    "progress": {
      "type": "object",
      "required": ["total_quizzes", "correct_rate", "last_study_date"],
      "properties": {
        "total_quizzes": {
          "type": "integer",
          "minimum": 0,
          "description": "Total quizzes completed"
        },
        "correct_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Overall correct answer rate (percentage)"
        },
        "last_study_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "Last study date (YYYY-MM-DD)"
        },
        "perfect_quizzes": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of perfect quizzes (100% correct)"
        },
        "expressions_learned": {
          "type": "integer",
          "minimum": 0,
          "description": "Total expressions learned"
        }
      }
    },
    "recent_topics": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "maxItems": 50,
      "description": "Recent topic fingerprints for deduplication"
    },
    "error_notebook": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["date", "question", "user_answer", "correct_answer", "explanation"],
        "properties": {
          "date": { "type": "string", "format": "date" },
          "question": { "type": "string" },
          "user_answer": { "type": "string" },
          "correct_answer": { "type": "string" },
          "explanation": { "type": "string" },
          "reviewed": { "type": "boolean", "default": false },
          "wrong_count": { "type": "integer", "default": 1, "minimum": 1, "description": "Number of times this question was answered incorrectly" },
          "keypoint_date": { "type": "string", "format": "date", "description": "Date of the associated knowledge point" },
          "question_type": { "type": "string", "enum": ["multiple_choice", "fill_blank", "dialogue_completion", "chinglish_fix"], "description": "Type of quiz question" }
        }
      },
      "description": "Wrong answers for review"
    },
    "error_archive": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["date", "question", "user_answer", "correct_answer", "explanation"],
        "properties": {
          "date": { "type": "string", "format": "date" },
          "question": { "type": "string" },
          "user_answer": { "type": "string" },
          "correct_answer": { "type": "string" },
          "explanation": { "type": "string" },
          "reviewed": { "type": "boolean", "default": false },
          "wrong_count": { "type": "integer", "default": 1, "minimum": 1 },
          "keypoint_date": { "type": "string", "format": "date" },
          "question_type": { "type": "string", "enum": ["multiple_choice", "fill_blank", "dialogue_completion", "chinglish_fix"] },
          "archived_at": { "type": "string", "format": "date", "description": "Date when this error was archived" }
        }
      },
      "description": "Archived stubborn errors (wrong_count >= 3 and over 30 days old)"
    }
  }
}
